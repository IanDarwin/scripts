#!/bin/ksh

# watchlog - consolidate watchlog functionality.

PATH=/bin:/usr/bin:$PATH; export PATH

USAGE="$0 [-f] logname"

function usage {		# give usage message, and exit
	echo "Usage: $USAGE" 2>&1
	exit 1
}

NUM=""
MORE=cat
while getopts "fmn:" opt 
do 
 	 case "$opt" in 
		f)	TAIL_F=-f;;
		m)	MORE="more";;
		n)	NUM=-${OPTARG};;
		*)	usage;;
	esac
done
shift `expr $OPTIND - 1`		 # leave just filenames

#if [ $# -eq 0 ]; then
#	usage
#fi

for f
do
	case $f in
		-*) ;;
		"")	echo "Usage: $0 logname" >&2; exit 1;;
		all)	exec xtail /var/log ~/tomcat/logs;;
		cvs|chang*) LOG=/cvs/CVSROOT/ChangeLog ;;
		daem*|ppp) LOG=/var/log/daemon ;;
		ftp)	LOG=/var/log/ftpd;;
		http|web|www) LOG=/var/www/logs/access_log ;;
		httperr|weberr) LOG=/var/www/logs/error_log ;;
		icb)	LOG=~/hacklog/`date +%Y-%m`;;	# only on cvs
		jserv)	LOG=/var/www/logs/mod_jserv.log;;
		lp*)	LOG=/var/log/lpd-errs;;
		mail)	LOG=/var/log/maillog ;;
		mess*)	LOG=/var/log/messages ;;
		pf|fw)	exec tcpdump -n -e -ttt -i pflog0;;
		ppp|chat)	LOG=/var/log/chat ;;
		secure)	LOG=/var/log/secure ;;
		snort)	LOG=/var/log/snort/alert ;;
		squid)	LOG=/var/squid/logs/access.log ;;
		tomcat)	
			cd /var/tomcat/logs
			LOGS=`ls -tr | tail -3`
			;;
		vnc)	LOG=~/.vnc/*.log;;
		x|X)	LOG=/var/log/XFree86.0.log;;
		x|xsess*|xerr*) LOG=~/.xsession-errors;;
		*)	echo "Unknown service $f" >&2
			continue;;
	esac

	if [ "" != "${LOGS}" ]; then
		# handle multiple files CONCURRENTLY WITH -f
		echo ========== $f ==========
		vi ${NUM} ${TAIL_ARG} ${LOGS}
	else 
		if [ ! -r ${LOG} ]; then
			echo "$0: $LOG unreadable!!" >&2
			logger $0: $LOG unreadable
			continue
		fi
		echo ========== $LOG ==========
		tail $TAIL_F $NUM $LOG
	fi

done

exit 0

# TODO -- handle XTERM case

case "$DISPLAY" in
	"") exec /usr/local/libexec/watchlog;;
	*) exec xterm -fn fixed -geometry 132x24 -e /usr/local/libexec/watchlog;;
esac


case $WAIT in
	yes) wait;;
esac
